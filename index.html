<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Comparador de Supermercados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{font-family:sans-serif;background:#f3f8fe;margin:0}
        header{background:#1479cb;color:#fff;padding:16px 8px;text-align:center;}
        .search-bar{margin:19px auto 12px;text-align:center;}
        #searchInput{width:300px;max-width:96vw;padding:10px 14px;border:2px solid #1479cb;border-radius:24px;font-size:1em;}
        .products-list{display:flex;flex-wrap:wrap;gap:19px;justify-content:center;}
        .product-card{background:#fff;padding:13px 9px 19px 9px;border-radius:13px;box-shadow:0 2.5px 13px #bfdcf74f;display:flex;flex-direction:column;align-items:center;width:189px;}
        .product-card img{max-width:78px;max-height:75px;margin-bottom:8px;background:#ececec;border-radius:7px;}
        .product-title{font-weight:bold;font-size:1.08em;margin-bottom:6px;margin-top:7px;text-align:center;}
        .product-category{color:#2589c0;font-size:.97em;}
        .price-table{width:98%;margin:10px auto 2px;border-collapse:collapse;}
        .price-table td{padding:4px 5px;font-size:.98em;}
        .add-cart-btn{margin-top:8px;background:#1479cb;color:#fff;border:none;border-radius:18px;padding:6px 19px;font-weight:bold;cursor:pointer;}
        .cart-fab{position:fixed;right:22px;bottom:22px;background:#1479cb;color:#fff;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2em;box-shadow:0 2px 18px #abcdeb;cursor:pointer;z-index:200;}
        .cart-count{position:absolute;top:5px;right:8px;background:#e53636;color:#fff;width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-weight:bold;}
        .cart-modal-bg{display:none;position:fixed;z-index:210;left:0;top:0;width:100vw;height:100vh;background:rgba(40,65,120,.14);}
        .cart-modal{display:none;position:fixed;right:0;top:0;max-width:99vw;width:380px;z-index:211;height:100vh;background:#fff;box-shadow:-6px 0 22px #b6cef7;padding-bottom:20px;overflow-y:auto;}
        .cart-header{background:#1479cb;color:#fff;padding:13px 16px 10px;font-size:1.12em;display:flex;justify-content:space-between;align-items:center}
        .cart-header button{background:none;border:none;color:#fff;font-size:1.3em;font-weight:bold;cursor:pointer;}
        .cart-items{padding:13px;}
        .cart-item{display:flex;align-items:center;margin-bottom:13px;}
        .cart-item img{max-width:43px;max-height:39px;margin-right:7px;border-radius:4px;}
        .cart-item-title{font-weight:600;margin-bottom:3px;}
        .cart-item-price{color:#1479cb;font-size:.97em;}
        .cart-qty-div{display:flex;align-items:center;margin-top:5px;}
        .cart-qty-div button{background:#1479cb;color:#fff;width:21px;height:22px;border-radius:7px;border:none;cursor:pointer;}
        .cart-qty-div input{width:29px;height:20px;text-align:center;}
        .cart-remove{background:#e53636;color:#fff;border:none;border-radius:7px;font-size:.97em;padding:3px 6px;cursor:pointer;margin-left:5px;}
        .cart-footer{padding:14px 19px;}
        .cart-finalizar{background:#43a84a;color:#fff;border:none;border-radius:16px;padding:9px 16px;font-size:1.08em;font-weight:bold;cursor:pointer;width:100%;margin-top:13px;}
        .compare-modal-bg{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(24,46,63,.18);z-index:300;}
        .compare-modal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:24px 11px 15px;max-width:92vw;width:360px;border-radius:15px;z-index:310;}
        .compare-title{text-align:center;font-weight:700;font-size:1.15em;color:#1479cb;margin-bottom:14px;}
        .compare-table{width:96%;margin:auto;border-collapse:collapse;}
        .compare-table th,.compare-table td{padding:7px 6px;text-align:center;}
        .compare-table th{background:#1479cb;color:#fff;}
        .compare-best{background:#43a84a;color:#fff;font-weight:bold;}
        .compare-worst{background:#e53636;color:#fff;font-weight:bold;}
        .compare-mid{background:#fbbd35;color:#fff;font-weight:bold;}
        .compare-close{position:absolute;right:19px;top:13px;background:none;border:none;color:#e53636;font-size:1.41em;font-weight:bold;cursor:pointer;}
        #toast{visibility:hidden;min-width:180px;position:fixed;z-index:4000;left:50%;top:18px;margin-left:-100px;background:#2589c0;color:#fff;font-weight:600;text-align:center;border-radius:7px;padding:10px;font-size:.99em;box-shadow:0 .7px 8px #dcdcf9;}
        #toast.success{background:#43a84a;}
        #toast.error{background:#e53636;}
        #toast.info{background:#1479cb;}
        @media (max-width:600px){
            #searchInput{width:98vw;}
            .product-card{width:99vw;}
            .cart-modal{width:99vw;}
            .compare-modal{width:99vw;}
        }
    </style>
</head>
<body>
    <header>
        <h1>Comparador de Supermercados</h1>
        <p>Pesquise por um produto, adicione ao carrinho, e compare o pre√ßo em cada supermercado!</p>
    </header>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Busque por produto..." oninput="listarProdutos()">
    </div>
    <div class="products-list" id="productsContainer">
        <div>Carregando produtos...</div>
    </div>
    <div class="cart-fab" id="cartFab" onclick="abrirCarrinho()" title="Abrir carrinho">
        üõí<span class="cart-count" id="cartCount" style="display:none;">0</span>
    </div>
    <!-- Carrinho -->
    <div class="cart-modal-bg" id="cartModalBg" onclick="fecharCarrinho()"></div>
    <aside class="cart-modal" id="cartModal">
        <div class="cart-header">
            <span>Seu Carrinho</span>
            <button onclick="fecharCarrinho()">&times;</button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-footer">
            <button class="cart-finalizar" onclick="compararPrecos()">Comparar pre√ßos</button>
            <div class="cart-info" id="cartSubtotal"></div>
        </div>
    </aside>
    <!-- Compara√ß√£o -->
    <div class="compare-modal-bg" id="compareModalBg" onclick="fecharComparacao()"></div>
    <div class="compare-modal" id="compareModal">
        <button class="compare-close" onclick="fecharComparacao()">&times;</button>
        <div class="compare-title">Comparativo de Pre√ßo</div>
        <div id="compareTableContainer"></div>
    </div>
    <div id="toast"></div>
<script>
// Defina aqui o link CSV p√∫blico da sua planilha
const LINK_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-dB_7ATOb6_pfxzOey8AzH5zS92qIGtloBdDHkbbPk-8Nltgb15PeR_s0VBpVj58pspSAfIW_Bb97/pub?output=csv";
const BASE_IMG = 'https://gabryelteixeirasousa-cpu.github.io/supermercado-site/';

const SUPS = [
    { market:"BH", cor:'#1479cb' },
    { market:"Duvale", cor:'#fbbd35' },
    { market:"CD", cor:'#43a84a' }
];

let PRODUTOS = [];
let carrinho = [];

/* --- CSV --- */
async function carregarProdutos(){
    const resp = await fetch(LINK_CSV);
    const txt = await resp.text();
    const linhas = txt.trim().split('\n');
    const chaves = linhas[0].split(',').map(t=>t.trim().replace(/"/g,''));
    PRODUTOS = linhas.slice(1).map(linha=>{
        let col=linha.split(',').map(t=>t.trim().replace(/"/g,''));
        let prod={};
        chaves.forEach((k,i)=>prod[k]=col[i]);
        return prod;
    });
    listarProdutos();
}
function getNomeCorretoImagem(nome){
    return nome ? nome.replace(/ /g,"_") : "";
}
function listarProdutos() {
    let filtro = document.getElementById("searchInput").value.toLowerCase().trim();
    let html = '';
    let prodFiltrados = PRODUTOS.filter(p=>{
        return (
            p.nome.toLowerCase().includes(filtro) ||
            p.categoria.toLowerCase().includes(filtro)
        );
    });
    prodFiltrados.forEach(prod => {
        let imgUrl = prod.imagem.startsWith('http') ? prod.imagem
                    : (BASE_IMG + prod.imagem);
        html += `
        <div class="product-card">
            <img src="${imgUrl}" alt="${prod.nome}">
            <div class="product-title">${prod.nome}</div>
            <div class="product-category">${prod.categoria||''}</div>
            <table class="price-table">
                <tr><td style="color:#1479cb;">BH</td><td>R$ ${Number(prod.BH).toFixed(2)}</td></tr>
                <tr><td style="color:#fbbd35;">Duvale</td><td>R$ ${Number(prod.Duvale).toFixed(2)}</td></tr>
                <tr><td style="color:#43a84a;">CD</td><td>R$ ${Number(prod.CD).toFixed(2)}</td></tr>
            </table>
            <div style="margin-top:8px;">
                <button class="add-cart-btn" onclick="addAoCarrinho('${prod.nome}')">Adicionar ao carrinho</button>
            </div>
        </div>
        `;
    });
    document.getElementById('productsContainer').innerHTML = html || `<div style="margin:30px auto;text-align:center;opacity:.6;">Nenhum produto encontrado...</div>`;
}
function addAoCarrinho(prodName){
    let prod = PRODUTOS.find(p=>p.nome==prodName);
    if(!prod) return;
    let idx = carrinho.findIndex(it=>it.nome==prodName);
    if(idx>-1){ carrinho[idx].qtd++; }
    else { carrinho.push({ nome:prodName, qtd:1 }); }
    saveCarrinho();
    showToast("Adicionado ao carrinho!","success");
    atualizaFab();
}
function abrirCarrinho(){
    listarCarrinho();
    document.getElementById("cartModalBg").style.display='block';
    document.getElementById("cartModal").style.display='block';
}
function fecharCarrinho(){
    document.getElementById("cartModalBg").style.display='none';
    document.getElementById("cartModal").style.display='none';
}
function listarCarrinho(){
    let html = '';
    let total = 0;
    carrinho.forEach(item => {
        let prod = PRODUTOS.find(p=>p.nome==item.nome);
        if(!prod) return;
        let imgUrl = prod.imagem.startsWith('http') ? prod.imagem : (BASE_IMG + prod.imagem);
        html += `<div class="cart-item">
            <img src="${imgUrl}" alt="${item.nome}">
            <div>
                <div class="cart-item-title">${item.nome}</div>
                <div class="cart-item-price">
                    <span>Qtd: <button onclick="cartMudaQtd('${item.nome}',-1)">-</button>
                    <input type="number" min="1" value="${item.qtd}" style="width:25px;" onchange="cartDefQtd('${item.nome}',this.value)">
                    <button onclick="cartMudaQtd('${item.nome}',1)">+</button></span>
                    <button class="cart-remove" onclick="removerDoCarrinho('${item.nome}')">&times;</button>
                </div>
            </div>
        </div>`;
    });
    document.getElementById('cartItems').innerHTML = html || `<div style="text-align:center;opacity:.74;">Seu carrinho est√° vazio.</div>`;
    // n√£o soma valor ainda para subtotal (n√£o h√° mercado definido)
}
function cartMudaQtd(nome,delta){
    let idx=carrinho.findIndex(i=>i.nome==nome);
    if(idx>-1){ carrinho[idx].qtd+=delta;if(carrinho[idx].qtd<1) carrinho[idx].qtd=1;}
    saveCarrinho();listarCarrinho();atualizaFab();
}
function cartDefQtd(nome,val){
    let idx=carrinho.findIndex(i=>i.nome==nome);
    if(idx>-1 && val>=1){ carrinho[idx].qtd=Number(val);}
    saveCarrinho();listarCarrinho();atualizaFab();
}
function removerDoCarrinho(nome){
    carrinho=carrinho.filter(i=>i.nome!=nome);
    saveCarrinho();listarCarrinho();atualizaFab();
}
/* Comparar Pre√ßos */
function compararPrecos(){
    if(!carrinho.length){showToast("Carrinho vazio!","error");return;}
    let totais = SUPS.map(s=>{
        let tot = 0;
        for(const c of carrinho){
            let prod = PRODUTOS.find(p=>p.nome==c.nome);
            if(prod && prod[s.market]) tot += Number(prod[s.market])*c.qtd;
        }
        return {market:s.market, valor:tot, cor:s.cor};
    });
    let min = Math.min(...totais.map(t=>t.valor));
    let max = Math.max(...totais.map(t=>t.valor));
    let html = `<table class="compare-table"><tr>
        <th>Supermercado</th><th>Total</th><th>Dica</th>
    </tr>`;
    for(const t of totais){
        let classe = (t.valor==min)?"compare-best" : (t.valor==max)?"compare-worst":"compare-mid";
        let dica = (t.valor==min)?"Mais vantajoso!" : (t.valor==max)?"Mais caro":"Intermedi√°rio";
        html += `<tr class="${classe}">
            <td style="font-weight:bold;color:${t.cor}">${t.market}</td>
            <td>R$ ${t.valor.toFixed(2)}</td>
            <td>${dica}</td>
        </tr>`;
    }
    html+=`</table>`;
    document.getElementById('compareTableContainer').innerHTML=html;
    document.getElementById('compareModalBg').style.display='block';
    document.getElementById('compareModal').style.display='block';
}
function fecharComparacao(){
    document.getElementById('compareModalBg').style.display='none';
    document.getElementById('compareModal').style.display='none';
}
function atualizaFab(){
    let count = carrinho.reduce((a,b)=>a+b.qtd,0);
    let el = document.getElementById("cartCount");
    el.style.display = count>0?'flex':'none';
    el.textContent = count;
}
function saveCarrinho(){localStorage.setItem('cartGS',JSON.stringify(carrinho));}
function loadCarrinho(){carrinho=JSON.parse(localStorage.getItem('cartGS')||'[]');atualizaFab();}
function showToast(msg, tipo){
    let el = document.getElementById("toast");
    el.textContent = msg; el.className=tipo||'info';
    el.style.visibility='visible';
    setTimeout(()=>{el.style.visibility='hidden';}, 2000);
}
window.onload=()=>{loadCarrinho();carregarProdutos();}
</script>
</body>
</html>
